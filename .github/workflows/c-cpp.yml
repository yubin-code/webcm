name: Build WebCM

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pigz make wget

      # ========================================================
      # 【核心绝杀：避开 Git 协议，直接下载源码压缩包】
      # 1. 既然 GitHub 连不上 adelielinux 的 Git
      # 2. 我们从 Alpine 的官方 distfiles 下载 gcompat 的源码包
      # 3. 将其解压并命名为 Docker 期望的目录名
      # ========================================================
      - name: Download gcompat source and patch Dockerfile
        run: |
          # 下载 gcompat v0.4.0 (这通常是你 Dockerfile 里 commit 对应的版本)
          wget --user-agent="Mozilla/5.0" https://distfiles.adelielinux.org/source/gcompat/gcompat-0.4.0.tar.xz
          mkdir -p gcompat
          tar -xf gcompat-0.4.0.tar.xz -C gcompat --strip-components=1
          
          # 修改 Dockerfile：
          # 把原来的 RUN git clone ... 这一行直接删掉
          # 替换为 COPY gcompat ./gcompat
          # 注意：这里的 sed 匹配模式要和你 Dockerfile 里的内容尽量对上
          sed -i '/git clone.*gcompat.git/d' rootfs.Dockerfile
          
          # 在原来的位置插入 COPY 指令（这里假设在第 42 行附近）
          # 我们直接在 Dockerfile 的 FROM 之后插入 COPY
          sed -i '/FROM toolchain-stage AS gcompat-stage/a COPY gcompat ./gcompat' rootfs.Dockerfile
          
          echo "✅ Dockerfile 已经修改为本地注入模式，不再依赖网络下载 gcompat"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Project
        run: make gh-pages

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webcm-build-files
          path: gh-pages/
