name: Build WebCM

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af
          df -h
      
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
      
      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/riscv64
      
      - name: åˆ›å»ºç¼“å­˜ç›®å½•
        run: |
          mkdir -p .cache
          mkdir -p .buildx-cache
      
      - name: æ„å»º Docker æ„å»ºå™¨é•œåƒ
        run: |
          docker build --platform=linux/amd64 \
            --tag webcm/builder \
            --file builder.Dockerfile \
            --progress plain \
            --network=host \
            . 2>&1 | tee build.log
          touch .webcm-builder
      
      - name: ä¸‹è½½ emscripten-pty.js
        run: |
          max_attempts=3
          attempt=0
          until [ $attempt -ge $max_attempts ]; do
            attempt=$((attempt+1))
            echo "å°è¯• $attempt/$max_attempts..."
            if docker run --platform=linux/amd64 \
              --volume=.:/mnt \
              --workdir=/mnt \
              --user=$(id -u):$(id -g) \
              --env=HOME=/tmp \
              --rm webcm/builder \
              wget -O emscripten-pty.js \
              --timeout=30 \
              --tries=3 \
              https://raw.githubusercontent.com/mame/xterm-pty/f284cab414d3e20f27a2f9298540b559878558db/emscripten-pty.js; then
              touch emscripten-pty.js
              break
            fi
            if [ $attempt -lt $max_attempts ]; then
              echo "ä¸‹è½½å¤±è´¥,ç­‰å¾… 10 ç§’åé‡è¯•..."
              sleep 10
            fi
          done
          if [ ! -f emscripten-pty.js ]; then
            echo "ä¸‹è½½å¤±è´¥"
            exit 1
          fi
      
      - name: ä¸‹è½½ linux.bin
        run: |
          max_attempts=3
          attempt=0
          until [ $attempt -ge $max_attempts ]; do
            attempt=$((attempt+1))
            echo "å°è¯• $attempt/$max_attempts..."
            if docker run --platform=linux/amd64 \
              --volume=.:/mnt \
              --workdir=/mnt \
              --user=$(id -u):$(id -g) \
              --env=HOME=/tmp \
              --rm webcm/builder \
              wget -O linux.bin \
              --timeout=60 \
              --tries=3 \
              https://github.com/cartesi/machine-linux-image/releases/download/v0.20.0/linux-6.5.13-ctsi-1-v0.20.0.bin; then
              touch linux.bin
              break
            fi
            if [ $attempt -lt $max_attempts ]; then
              echo "ä¸‹è½½å¤±è´¥,ç­‰å¾… 10 ç§’åé‡è¯•..."
              sleep 10
            fi
          done
          if [ ! -f linux.bin ]; then
            echo "ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          ls -lh linux.bin
      
      - name: æ„å»º rootfs.tar
        run: |
          docker buildx build \
            --platform=linux/riscv64 \
            --progress plain \
            --network=host \
            --cache-from type=local,src=.buildx-cache \
            --cache-to type=local,dest=.buildx-cache-new,mode=max \
            --output type=tar,dest=rootfs.tar \
            --file rootfs.Dockerfile \
            . 2>&1 | tee rootfs-build.log
          
          # ç§»åŠ¨ç¼“å­˜ä»¥é¿å…ç¼“å­˜çˆ†ç‚¸
          rm -rf .buildx-cache
          if [ -d .buildx-cache-new ]; then
            mv .buildx-cache-new .buildx-cache
          fi
      
      - name: æ£€æŸ¥ rootfs.tar
        run: |
          ls -lh rootfs.tar
          file rootfs.tar
      
      - name: æ„å»º rootfs.ext2
        run: |
          docker run --platform=linux/amd64 \
            --volume=.:/mnt \
            --workdir=/mnt \
            --user=$(id -u):$(id -g) \
            --env=HOME=/tmp \
            --rm webcm/builder \
            xgenext2fs \
              --faketime \
              --allow-holes \
              --size-in-blocks 98304 \
              --block-size 4096 \
              --bytes-per-inode 4096 \
              --volume-label rootfs \
              --tarball rootfs.tar rootfs.ext2
          ls -lh rootfs.ext2
      
      - name: å‹ç¼© rootfs.ext2
        run: |
          docker run --platform=linux/amd64 \
            --volume=.:/mnt \
            --workdir=/mnt \
            --user=$(id -u):$(id -g) \
            --env=HOME=/tmp \
            --rm webcm/builder \
            sh -c "cat rootfs.ext2 | pigz -cz -11 > rootfs.ext2.zz"
          ls -lh rootfs.ext2.zz
      
      - name: å‹ç¼© linux.bin
        run: |
          docker run --platform=linux/amd64 \
            --volume=.:/mnt \
            --workdir=/mnt \
            --user=$(id -u):$(id -g) \
            --env=HOME=/tmp \
            --rm webcm/builder \
            sh -c "cat linux.bin | pigz -cz -11 > linux.bin.zz"
          ls -lh linux.bin.zz
      
      - name: ç¼–è¯‘ WebAssembly
        run: |
          docker run --platform=linux/amd64 \
            --volume=.:/mnt \
            --workdir=/mnt \
            --user=$(id -u):$(id -g) \
            --env=HOME=/tmp \
            --env=EM_CACHE=/mnt/.cache \
            --env=PIGZ_LEVEL=11 \
            --rm webcm/builder \
            em++ webcm.cpp -o webcm.mjs \
              -Oz -g0 -std=gnu++23 \
              -I/opt/emscripten-cartesi-machine/include \
              -L/opt/emscripten-cartesi-machine/lib \
              -lcartesi \
              --js-library=emscripten-pty.js \
              -Wall -Wextra -Wno-unused-function -Wno-c23-extensions \
              -sASYNCIFY \
              -sFETCH \
              -sSTACK_SIZE=4MB \
              -sTOTAL_MEMORY=768MB \
              -sEXPORTED_RUNTIME_METHODS=ccall,cwrap,UTF8ToString,stringToUTF8
          ls -lh webcm.mjs webcm.wasm
      
      - name: å¤åˆ¶æ–‡ä»¶åˆ° gh-pages ç›®å½•
        run: |
          mkdir -p gh-pages
          if [ -f index.html ]; then cp index.html gh-pages/; fi
          if [ -f webcm.mjs ]; then cp webcm.mjs gh-pages/; fi
          if [ -f webcm.wasm ]; then cp webcm.wasm gh-pages/; fi
          if [ -f favicon.svg ]; then cp favicon.svg gh-pages/; fi
          ls -la gh-pages/
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: webcm-build-${{ github.sha }}
          path: |
            webcm.mjs
            webcm.wasm
            rootfs.ext2
            rootfs.ext2.zz
            linux.bin
            linux.bin.zz
            gh-pages/
          retention-days: 30
          compression-level: 0
      
      - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.sha }}
          path: |
            build.log
            rootfs-build.log
          retention-days: 7
      
      - name: æ˜¾ç¤ºæ„å»ºæ€»ç»“
        run: |
          echo "=== æ„å»ºå®Œæˆ ==="
          echo ""
          echo "æ„å»ºäº§ç‰©:"
          ls -lh webcm.mjs webcm.wasm rootfs.ext2.zz linux.bin.zz 2>/dev/null || true
          echo ""
          echo "æ–‡ä»¶å¤§å°:"
          du -h webcm.mjs webcm.wasm rootfs.ext2.zz linux.bin.zz 2>/dev/null || true
          echo ""
          echo "æ€»å¤§å°:"
          du -sh gh-pages/ 2>/dev/null || true
          echo ""
          echo "âœ… æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° Artifacts"
          echo "ğŸ“¥ å¯åœ¨ Actions é¡µé¢ä¸‹è½½"
